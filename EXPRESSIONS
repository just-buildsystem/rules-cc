{ "field_artifacts":
  { "vars": ["fieldname", "transition"]
  , "expression":
    { "type": "map_union"
    , "$1":
      { "type": "foreach"
      , "var": "x"
      , "range":
        {"type": "FIELD", "name": {"type": "var", "name": "fieldname"}}
      , "body":
        { "type": "DEP_ARTIFACTS"
        , "dep": {"type": "var", "name": "x"}
        , "transition":
          { "type": "var"
          , "name": "transition"
          , "default": {"type": "empty_map"}
          }
        }
      }
    }
  }
, "field_runfiles":
  { "vars": ["fieldname", "transition"]
  , "expression":
    { "type": "map_union"
    , "$1":
      { "type": "foreach"
      , "var": "x"
      , "range":
        {"type": "FIELD", "name": {"type": "var", "name": "fieldname"}}
      , "body":
        { "type": "DEP_RUNFILES"
        , "dep": {"type": "var", "name": "x"}
        , "transition":
          { "type": "var"
          , "name": "transition"
          , "default": {"type": "empty_map"}
          }
        }
      }
    }
  }
, "action_env":
  { "vars": ["ENV"]
  , "expression":
    { "type": "map_union"
    , "$1":
      [ {"type": "singleton_map", "key": "PATH", "value": "/bin:/usr/bin"}
      , {"type": "var", "name": "ENV", "default": {"type": "empty_map"}}
      ]
    }
  }
, "stage_singleton_field":
  { "vars": ["fieldname", "transition", "location"]
  , "expression":
    { "type": "assert_non_empty"
    , "msg":
      ["No artifact specified in field", {"type": "var", "name": "fieldname"}]
    , "$1":
      { "type": "disjoint_map_union"
      , "msg":
        [ "Expecting (essentially) a single artifact in field"
        , {"type": "var", "name": "fieldname"}
        ]
      , "$1":
        { "type": "foreach"
        , "var": "src"
        , "range":
          {"type": "FIELD", "name": {"type": "var", "name": "fieldname"}}
        , "body":
          { "type": "disjoint_map_union"
          , "$1":
            { "type": "foreach"
            , "var": "artifact"
            , "range":
              { "type": "values"
              , "$1":
                { "type": "DEP_ARTIFACTS"
                , "dep": {"type": "var", "name": "src"}
                , "transition":
                  { "type": "var"
                  , "name": "transition"
                  , "default": {"type": "empty_map"}
                  }
                }
              }
            , "body":
              { "type": "singleton_map"
              , "key": {"type": "var", "name": "location"}
              , "value": {"type": "var", "name": "artifact"}
              }
            }
          }
        }
      }
    }
  }
, "stage_artifact_to_singleton_field":
  { "vars": ["artifact", "fieldname", "transition"]
  , "expression":
    { "type": "let*"
    , "bindings":
      [ [ "location"
        , { "type": "++"
          , "$1":
            { "type": "foreach"
            , "var": "src"
            , "range":
              {"type": "FIELD", "name": {"type": "var", "name": "fieldname"}}
            , "body":
              { "type": "keys"
              , "$1":
                { "type": "DEP_ARTIFACTS"
                , "dep": {"type": "var", "name": "src"}
                , "transition":
                  { "type": "var"
                  , "name": "transition"
                  , "default": {"type": "empty_map"}
                  }
                }
              }
            }
          }
        ]
      , [ "staged_artifact"
        , { "type": "foreach_map"
          , "range": {"type": "var", "name": "artifact"}
          , "var_val": "val"
          , "body":
            { "type": "foreach"
            , "range": {"type": "var", "name": "location"}
            , "var": "pos"
            , "body":
              { "type": "singleton_map"
              , "key": {"type": "var", "name": "pos"}
              , "value": {"type": "var", "name": "val"}
              }
            }
          }
        ]
      ]
    , "body":
      { "type": "disjoint_map_union"
      , "$1": {"type": "++", "$1": {"type": "var", "name": "staged_artifact"}}
      }
    }
  }
}
